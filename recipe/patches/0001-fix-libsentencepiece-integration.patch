From db4a4d80c6399f35c1892043d8a1a5c5275def02 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Mon, 17 Nov 2025 20:25:39 +1100
Subject: [PATCH] fix libsentencepiece integration

use a newer sentencepiece than the currently latest v0.2.1, to be able to control
(un)vendoring of abseil when using private headers; diff to last version is negligible:
https://github.com/google/sentencepiece/compare/v0.2.1..6dadda597b9e19ad3efb8890585f0b92266c7c0e
---
 src/CMakeLists.txt | 43 ++++++++++++++++++++++++-------------------
 1 file changed, 24 insertions(+), 19 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index ae334e12..022f3068 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -74,10 +74,15 @@ else()
   include(${PROJECT_SOURCE_DIR}/cmake/external/icu.cmake)
 endif()
 
+find_package(sentencepiece REQUIRED)
+if(sentencepiece_FOUND)
+  find_package(absl REQUIRED)
+endif()
+
 FetchContent_Declare(
   sentencepiece
-  URL      https://github.com/google/sentencepiece/releases/download/v0.2.1/sentencepiece-0.2.1.tar.gz
-  URL_HASH SHA256=8138cec27c2f2282f4a34d9a016e3374cd40e5c6e9cb335063db66a0a3b71fad
+  URL      https://github.com/google/sentencepiece/archive/refs/tags/v0.2.1.tar.gz
+  URL_HASH SHA256=c1a59e9259c9653ad0ade653dadff074cd31f0a6ff2a11316f67bee4189a8f1b
 )
 FetchContent_GetProperties(sentencepiece)
 if(NOT sentencepiece_POPULATED)
@@ -88,7 +93,7 @@ if(NOT sentencepiece_POPULATED)
       set(CMAKE_FIND_PACKAGE_PREFER_CONFIG ON)
       set(protobuf_MODULE_COMPATIBLE ON CACHE BOOL "Protobuf module compatible")
   endif()
-  if(openvino_installed_from_conda AND NOT WIN32)
+  if(openvino_installed_from_conda)
       set(SPM_USE_BUILTIN_PROTOBUF OFF CACHE BOOL "")
       set(SPM_PROTOBUF_PROVIDER "package" CACHE STRING "")
       set(SPM_ABSL_PROVIDER "package" CACHE STRING "")
@@ -98,7 +103,7 @@ if(NOT sentencepiece_POPULATED)
       set(SPM_ABSL_PROVIDER "internal" CACHE STRING "")
   endif()
 
-  set(SPM_ENABLE_SHARED OFF CACHE BOOL "")
+  set(SPM_ENABLE_SHARED ON CACHE BOOL "")
   set(SPM_ENABLE_TCMALLOC OFF CACHE BOOL "")
   set(SPM_ENABLE_NFKC_COMPILE ON CACHE BOOL "Enable NFKC compile")
 
@@ -120,15 +125,15 @@ if(NOT sentencepiece_POPULATED)
     endif()
   endif()
 
-  if(EXISTS "${_sp_src}/CMakeLists.txt")
-    if(NOT _sp_src STREQUAL sentencepiece_SOURCE_DIR)
-      message(STATUS "Adjusted sentencepiece source dir to: ${_sp_src}")
-      # don't rely on changing the cached FetchContent variable; use _sp_src directly
-    endif()
-    add_subdirectory("${_sp_src}" "${sentencepiece_BINARY_DIR}" EXCLUDE_FROM_ALL)
-  else()
-    message(WARNING "SentencePiece source does not contain CMakeLists.txt; skipping add_subdirectory().")
+  # vendored from https://github.com/google/sentencepiece/blob/v0.2.1/CMakeLists.txt#L184-L192
+  find_package(absl REQUIRED)
+  get_target_property(ABSL_INCLUDE_DIRS absl::base INTERFACE_INCLUDE_DIRECTORIES)
+  if (NOT EXISTS ${sentencepiece_SOURCE_DIR}/third_party/absl.org)
+    file(RENAME ${sentencepiece_SOURCE_DIR}/third_party/absl ${sentencepiece_SOURCE_DIR}/third_party/absl.org)
+    execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
+        ${ABSL_INCLUDE_DIRS}/absl ${sentencepiece_SOURCE_DIR}/third_party/absl)
   endif()
+  include_directories(${ABSL_INCLUDE_DIRS})
 
   if(TARGET ${ICU_TARGET_NAME})
     foreach(sp_target sentencepiece sentencepiece_train)
@@ -144,14 +149,14 @@ endif()
 function(ov_tokenizers_link_sentencepiece TARGET_NAME)
   if(sentencepiece_FOUND)
     foreach(sp_target sentencepiece sentencepiece_train)
-      if(TARGET ${sp_target}-static)
-        # on Windows conda-forge builds sentencepiece as static library
-        target_link_libraries(${TARGET_NAME} PRIVATE ${sp_target}-static)
-      else()
-        target_link_libraries(${TARGET_NAME} PRIVATE ${sp_target})
-      endif()
+      target_link_libraries(${TARGET_NAME} PRIVATE ${sp_target})
     endforeach()
     target_link_libraries(${TARGET_NAME} PRIVATE absl::string_view absl::flat_hash_set)
+    target_include_directories(${TARGET_NAME} SYSTEM PRIVATE
+      "${sentencepiece_SOURCE_DIR}/src" # for "normalizer.h", used in various places, e.g. normalize_unicode.hpp
+      "${sentencepiece_SOURCE_DIR}/third_party" # for "darts_clone/darts.h", used in unigram_tokenizer.hpp
+      "${sentencepiece_SOURCE_DIR}" # for "third_party/absl/", but see symlink replacement to actual abseil above
+    )
   else()
     if(SPM_PROTOBUF_PROVIDER STREQUAL "internal")
       if(SPM_ABSL_PROVIDER STREQUAL "package")
@@ -171,7 +176,7 @@ function(ov_tokenizers_link_sentencepiece TARGET_NAME)
         "${_sp_src}" # for "third_party/absl/strings/string_view.h"
         "${sentencepiece_BINARY_DIR}/src" # for "sentencepiece_model.pb.h"
         )
-      endif()
+    endif()
 
     foreach(sp_target sentencepiece-static sentencepiece_train-static)
       if(CMAKE_CL_64)
